#include "scan_bridge.h"
#include "ui_sidebar.h"
#include <gtk/gtk.h>

static gboolean scan_is_active(void) {
    gboolean running;
    g_mutex_lock(&global_scan_ctx.mutex);
    running = global_scan_ctx.is_running;
    g_mutex_unlock(&global_scan_ctx.mutex);
    return running;
}
// --- Helper Functions (Defined at TOP) ---
static void set_active_view(AppState *app, const char *view_name) {
    if (scan_is_active()) {
        // Force user to stay on progress screen
        gtk_stack_set_visible_child_name(GTK_STACK(app->stack), "progress");
        return;
    }

    gtk_stack_set_visible_child_name(GTK_STACK(app->stack), view_name);
}
// Wrappers
static void go_to_dashboard(GtkButton *btn, gpointer user_data) { set_active_view((AppState *)user_data, "dashboard"); }
static void go_to_history(GtkButton *btn, gpointer user_data) { set_active_view((AppState *)user_data, "history"); }
// This was the problem function - now defined correctly outside
static void go_to_settings_local(GtkButton *btn, gpointer user_data) {
    set_active_view((AppState *)user_data, "settings");
}

static void toggle_sidebar_collapse(GtkButton *btn, gpointer user_data) {
    AppState *app = (AppState *)user_data;
    app->is_sidebar_collapsed = !app->is_sidebar_collapsed;

    GList *iter = app->sidebar_labels;
    while (iter != NULL) {
        GtkWidget *label = GTK_WIDGET(iter->data);
        gtk_widget_set_visible(label, !app->is_sidebar_collapsed);
        iter = iter->next;
    }

    if (app->is_sidebar_collapsed) {
        gtk_widget_set_size_request(app->sidebar, 60, -1);
    } else {
        gtk_widget_set_size_request(app->sidebar, 200, -1);
    }
}

static GtkWidget *create_nav_item(AppState *app, const char *icon_name, const char *text) {
    GtkWidget *btn = gtk_button_new();
    gtk_widget_set_hexpand(btn, TRUE); 
    gtk_widget_add_css_class(btn, "nav-item");

    GtkWidget *box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 12);
    gtk_widget_set_halign(box, GTK_ALIGN_START);

    GtkWidget *icon = gtk_image_new_from_icon_name(icon_name);
    gtk_widget_set_size_request(icon, 16, 16); 
    gtk_box_append(GTK_BOX(box), icon);

    GtkWidget *label = gtk_label_new(text);
    gtk_box_append(GTK_BOX(box), label);

    app->sidebar_labels = g_list_append(app->sidebar_labels, label);
    gtk_button_set_child(GTK_BUTTON(btn), box);
    return btn;
}

GtkWidget *create_sidebar(AppState *app) {
    app->sidebar = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);
    gtk_widget_set_size_request(app->sidebar, 200, -1);
    gtk_widget_set_hexpand(app->sidebar, FALSE); 
    gtk_widget_add_css_class(app->sidebar, "sidebar");

    // Header
    GtkWidget *header_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);
    gtk_widget_set_margin_top(header_box, 15);
    gtk_widget_set_margin_start(header_box, 15);
    gtk_widget_set_margin_bottom(header_box, 20);

    GtkWidget *burger_btn = gtk_button_new();
    gtk_widget_add_css_class(burger_btn, "burger-btn");
    GtkWidget *burger_icon = gtk_image_new_from_icon_name("open-menu-symbolic");
    gtk_button_set_child(GTK_BUTTON(burger_btn), burger_icon);
    
    g_signal_connect(burger_btn, "clicked", G_CALLBACK(toggle_sidebar_collapse), app);
    gtk_box_append(GTK_BOX(header_box), burger_btn);
    gtk_box_append(GTK_BOX(app->sidebar), header_box);

    // Nav Items
    GtkWidget *nav_group = gtk_box_new(GTK_ORIENTATION_VERTICAL, 4);
    gtk_widget_set_margin_start(nav_group, 10);
    gtk_widget_set_margin_end(nav_group, 10);

    GtkWidget *btn_dash = create_nav_item(app, "view-grid-symbolic", "Dashboard");
    g_signal_connect(btn_dash, "clicked", G_CALLBACK(go_to_dashboard), app);
    gtk_box_append(GTK_BOX(nav_group), btn_dash);

    GtkWidget *btn_hist = create_nav_item(app, "document-open-recent-symbolic", "History");
    g_signal_connect(btn_hist, "clicked", G_CALLBACK(go_to_history), app);
    gtk_box_append(GTK_BOX(nav_group), btn_hist);

    gtk_box_append(GTK_BOX(app->sidebar), nav_group);
    // Spacer
    GtkWidget *spacer = gtk_label_new("");
    gtk_widget_set_vexpand(spacer, TRUE);
    gtk_box_append(GTK_BOX(app->sidebar), spacer);
    // Settings
    GtkWidget *sett_group = gtk_box_new(GTK_ORIENTATION_VERTICAL, 4);
    gtk_widget_set_margin_start(sett_group, 10);
    gtk_widget_set_margin_end(sett_group, 10);
    gtk_widget_set_margin_bottom(sett_group, 20);

    GtkWidget *btn_sett = create_nav_item(app, "preferences-system-symbolic", "Settings");
    g_signal_connect(btn_sett, "clicked", G_CALLBACK(go_to_settings_local), app);
    gtk_box_append(GTK_BOX(sett_group), btn_sett);

    gtk_box_append(GTK_BOX(app->sidebar), sett_group);

    return app->sidebar;
}