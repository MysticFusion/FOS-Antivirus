#include "ui_views.h"
#include "ui_scan.h"   
#include "ui_update.h" 
#include <gtk/gtk.h>
// --- Dashboard ---
static void start_quick_scan(GtkButton *btn, gpointer user_data) {
    start_scan_logic((AppState *)user_data, "QUICK_SCAN");
}

static void go_to_advanced(GtkButton *btn, gpointer user_data) {
    gtk_stack_set_visible_child_name(GTK_STACK(((AppState*)user_data)->stack), "advanced_scan");
}

GtkWidget *create_dashboard_view(AppState *app) {
    GtkWidget *col = gtk_box_new(GTK_ORIENTATION_VERTICAL, 20);
    gtk_widget_set_margin_start(col, 30); gtk_widget_set_margin_top(col, 30);
    gtk_widget_set_margin_end(col, 30);
    
    GtkWidget *title = gtk_label_new(NULL);
    gtk_label_set_markup(GTK_LABEL(title), "<span font='28px' weight='bold'>Overview</span>");
    gtk_widget_set_halign(title, GTK_ALIGN_START);
    gtk_box_append(GTK_BOX(col), title);

    // Scanner Card
    GtkWidget *card = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 20);
    gtk_widget_add_css_class(card, "dashboard-card-bg");
    gtk_widget_set_size_request(card, -1, 100);
    
    GtkWidget *icon = gtk_image_new_from_icon_name("media-record-symbolic");
    gtk_widget_set_size_request(icon, 40, 40); 
    gtk_widget_set_valign(icon, GTK_ALIGN_CENTER); 
    gtk_widget_set_margin_start(icon, 20);
    gtk_widget_add_css_class(icon, "scanner-icon");
    gtk_box_append(GTK_BOX(card), icon);
    
    GtkWidget *vbox = gtk_box_new(GTK_ORIENTATION_VERTICAL, 5);
    gtk_widget_set_valign(vbox, GTK_ALIGN_CENTER);
    GtkWidget *l1 = gtk_label_new("Quick Scan"); 
    gtk_widget_set_halign(l1, GTK_ALIGN_START); gtk_widget_add_css_class(l1, "bold-text");
    GtkWidget *l2 = gtk_label_new("Scans critical system areas"); 
    gtk_widget_set_halign(l2, GTK_ALIGN_START);
    gtk_box_append(GTK_BOX(vbox), l1); gtk_box_append(GTK_BOX(vbox), l2);
    gtk_box_append(GTK_BOX(card), vbox);
    
    GtkWidget *spacer = gtk_label_new(""); 
    gtk_widget_set_hexpand(spacer, TRUE); 
    gtk_box_append(GTK_BOX(card), spacer);

    GtkWidget *scan_btn = gtk_button_new_with_label("Start Scan");
    gtk_widget_add_css_class(scan_btn, "scan-btn"); 
    gtk_widget_set_margin_end(scan_btn, 20); gtk_widget_set_valign(scan_btn, GTK_ALIGN_CENTER);
    g_signal_connect(scan_btn, "clicked", G_CALLBACK(start_quick_scan), app);
    gtk_box_append(GTK_BOX(card), scan_btn);
    
    GtkWidget *adv_btn = gtk_button_new();
    gtk_widget_add_css_class(adv_btn, "flat-button");
    gtk_button_set_child(GTK_BUTTON(adv_btn), gtk_image_new_from_icon_name("view-more-horizontal-symbolic"));
    g_signal_connect(adv_btn, "clicked", G_CALLBACK(go_to_advanced), app);
    gtk_box_append(GTK_BOX(card), adv_btn);

    gtk_box_append(GTK_BOX(col), card);
    return col;
}
// --- Settings ---
static void on_dark_mode_toggled(GtkSwitch *widget, gboolean state, gpointer user_data) {
    AppState *app = (AppState *)user_data;
    app->is_dark_mode = state;
    update_theme(app);
}

GtkWidget *create_settings_view(AppState *app) {
    GtkWidget *view = gtk_box_new(GTK_ORIENTATION_VERTICAL, 20);
    gtk_widget_set_margin_start(view, 30); gtk_widget_set_margin_top(view, 30); gtk_widget_set_margin_end(view, 30);
    
    GtkWidget *title = gtk_label_new(NULL);
    gtk_label_set_markup(GTK_LABEL(title), "<span font='28px' weight='bold'>Settings</span>");
    gtk_widget_set_halign(title, GTK_ALIGN_START);
    gtk_box_append(GTK_BOX(view), title);   
    // Dark Mode Card
    GtkWidget *card = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 20);
    gtk_widget_add_css_class(card, "dashboard-card-bg");
    gtk_widget_set_size_request(card, -1, 80);
    
    GtkWidget *lbl = gtk_label_new("  Dark Mode");
    gtk_widget_add_css_class(lbl, "bold-text");
    gtk_box_append(GTK_BOX(card), lbl);
    
    GtkWidget *spacer = gtk_label_new(""); gtk_widget_set_hexpand(spacer, TRUE);
    gtk_box_append(GTK_BOX(card), spacer);
    
    GtkSwitch *sw = GTK_SWITCH(gtk_switch_new());
    gtk_switch_set_active(sw, app->is_dark_mode);
    g_signal_connect(sw, "state-set", G_CALLBACK(on_dark_mode_toggled), app);
    gtk_widget_set_margin_end(GTK_WIDGET(sw), 20);
    gtk_widget_set_valign(GTK_WIDGET(sw), GTK_ALIGN_CENTER);
    gtk_box_append(GTK_BOX(card), GTK_WIDGET(sw));
    gtk_box_append(GTK_BOX(view), card);
    // Threat Signature Update Card
    GtkWidget *update_card = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 20);
    gtk_widget_add_css_class(update_card, "dashboard-card-bg");
    gtk_widget_set_size_request(update_card, -1, 80);

    GtkWidget *upd_lbl = gtk_label_new("Threat Signature Database");
    gtk_widget_add_css_class(upd_lbl, "bold-text");
    gtk_widget_set_halign(upd_lbl, GTK_ALIGN_START);
    gtk_widget_set_valign(upd_lbl, GTK_ALIGN_CENTER);
    gtk_widget_set_margin_start(upd_lbl, 20);
    gtk_box_append(GTK_BOX(update_card), upd_lbl);

    GtkWidget *update_spacer = gtk_label_new("");
    gtk_widget_set_hexpand(update_spacer, TRUE);
    gtk_box_append(GTK_BOX(update_card), update_spacer);

    GtkWidget *right_box = gtk_box_new(GTK_ORIENTATION_VERTICAL, 4);
    gtk_widget_set_margin_end(right_box, 20);
    gtk_widget_set_halign(right_box, GTK_ALIGN_END);
    gtk_widget_set_valign(right_box, GTK_ALIGN_CENTER);

    GtkWidget *switch_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);
    gtk_widget_set_halign(switch_box, GTK_ALIGN_END);
    gtk_widget_set_valign(switch_box, GTK_ALIGN_CENTER);

    GtkSwitch *auto_sw = GTK_SWITCH(gtk_switch_new());
    gtk_switch_set_active(auto_sw, auto_update_enabled);
    gtk_widget_set_hexpand(GTK_WIDGET(auto_sw), FALSE);
    gtk_widget_set_vexpand(GTK_WIDGET(auto_sw), FALSE);
    gtk_widget_set_halign(GTK_WIDGET(auto_sw), GTK_ALIGN_END);
    gtk_widget_set_valign(GTK_WIDGET(auto_sw), GTK_ALIGN_CENTER);

    g_signal_connect(auto_sw, "state-set", G_CALLBACK(on_auto_update_toggled), app);

    gtk_box_append(GTK_BOX(switch_box), GTK_WIDGET(auto_sw));
    gtk_box_append(GTK_BOX(right_box), switch_box);

    char lbl_buf[128];

    snprintf(lbl_buf, sizeof(lbl_buf),
        "<span weight='bold'>Last Updated: %s</span>",
        last_update_time);


    GtkWidget *last_lbl = gtk_label_new(NULL);
    gtk_label_set_markup(GTK_LABEL(last_lbl), lbl_buf);

    app->last_update_label = last_lbl; // Storing in AppState now
    gtk_widget_set_halign(last_lbl, GTK_ALIGN_END);
    gtk_widget_add_css_class(last_lbl, "last-update-label");
    gtk_widget_add_css_class(last_lbl, "dim-label");

    gtk_box_append(GTK_BOX(right_box), last_lbl);
    gtk_box_append(GTK_BOX(update_card), right_box);
    gtk_box_append(GTK_BOX(view), update_card);

    return view;
}