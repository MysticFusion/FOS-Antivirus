#include "ui_history.h"
#include <gtk/gtk.h>
#include <windows.h> 
#include <stdio.h>
#include <string.h>
#include <stdlib.h> 

extern int restore_file_from_quarantine(const char *q_path, const char *dest_path);

typedef struct {
    char *orig_path;
    char *q_path;
    GtkWidget *lbl_status;
    GtkWidget *btn_restore;
    GtkWidget *btn_remove;
    AppState *app;
} HistoryActionData;

static void free_history_action_data(gpointer data) {
    HistoryActionData *d = (HistoryActionData *)data;
    if (d->orig_path) g_free(d->orig_path);
    if (d->q_path) g_free(d->q_path);
    g_free(d);
}
// 2. Updated Remove Callback
static void on_remove_clicked(GtkButton *btn, gpointer user_data) {
    HistoryActionData *data = (HistoryActionData *)user_data;
    remove(data->q_path); 

    gtk_label_set_text(GTK_LABEL(data->lbl_status), "Removed");
    gtk_widget_set_sensitive(data->btn_restore, FALSE);
    gtk_widget_set_sensitive(data->btn_remove, FALSE);

    GtkAlertDialog *alert = gtk_alert_dialog_new("File Permanently Removed");
    gtk_alert_dialog_show(alert, GTK_WINDOW(data->app->window));
    g_object_unref(alert);
    reload_history_view(data->app);
}
// 3. Updated Restore Callback
static void on_restore_clicked(GtkButton *btn, gpointer user_data) {
    HistoryActionData *data = (HistoryActionData *)user_data;
    
    if (restore_file_from_quarantine(data->q_path, data->orig_path) == 0) {
        gtk_label_set_text(GTK_LABEL(data->lbl_status), "Restored");
        gtk_widget_set_sensitive(data->btn_restore, FALSE);
        gtk_widget_set_sensitive(data->btn_remove, FALSE);
        
        GtkAlertDialog *alert = gtk_alert_dialog_new("File Restored Successfully");
        gtk_alert_dialog_show(alert, GTK_WINDOW(data->app->window));
        g_object_unref(alert);
        reload_history_view(data->app);
    } else {
        GtkAlertDialog *alert = gtk_alert_dialog_new("Failed to Restore. Check permissions.");
        gtk_alert_dialog_show(alert, GTK_WINDOW(data->app->window));
        g_object_unref(alert);
    }
}
// 4. Updated Load Function
void load_history_items(AppState *app) {
    // STEP 0: Clear existing children
    GtkWidget *child = gtk_widget_get_first_child(app->history_list_box);
    while (child != NULL) {
        GtkWidget *next = gtk_widget_get_next_sibling(child);
        gtk_list_box_remove(GTK_LIST_BOX(app->history_list_box), child);
        child = next;
    }

    FILE *f = fopen("history.log", "r");
    if (!f) return;

    // STEP 1: Track latest occurrence
    GHashTable *latest_entry = g_hash_table_new_full(
        g_str_hash, g_str_equal, g_free, g_free
    );

    char line[1024];

    int line_no = 0;

    while (fgets(line, sizeof(line), f)) {
        line[strcspn(line, "\r\n")] = 0;
        line_no++;

        char *copy = g_strdup(line);
        strtok(copy, "|");          // date
        strtok(NULL, "|");          // threat
        char *token_orig = strtok(NULL, "|");

        if (token_orig) {
            int *stored_line = g_new(int, 1);
            *stored_line = line_no;

            g_hash_table_replace(
                latest_entry,
                g_strdup(token_orig),
                stored_line
            );
        }
        g_free(copy);
    }


    rewind(f);

    line_no = 0;
    // PASS 2
    while (fgets(line, sizeof(line), f)) {
        line[strcspn(line, "\r\n")] = 0;

        char *token_date   = strtok(line, "|");
        char *token_threat = strtok(NULL, "|");
        char *token_orig   = strtok(NULL, "|");
        char *token_qpath  = strtok(NULL, "|");

        if (!token_date || !token_orig || !token_qpath) continue;

        line_no++;
        int *latest_line = g_hash_table_lookup(latest_entry, token_orig);
        bool is_latest = (latest_line && *latest_line == line_no);
        bool quarantine_exists = (GetFileAttributesA(token_qpath) != INVALID_FILE_ATTRIBUTES);

        char *filename = strrchr(token_orig, '\\');
        if (!filename) filename = strrchr(token_orig, '/');
        filename = (filename) ? filename + 1 : token_orig;

        // UI ROW
        GtkWidget *row = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 15);
        gtk_widget_set_margin_start(row, 10);
        gtk_widget_set_margin_end(row, 10);
        gtk_widget_set_margin_top(row, 8);
        gtk_widget_set_margin_bottom(row, 8);

        // 1. File Name
        GtkWidget *lbl_name = gtk_label_new(filename);
        gtk_widget_set_size_request(lbl_name, 120, -1);
        gtk_widget_set_halign(lbl_name, GTK_ALIGN_START);
        gtk_label_set_ellipsize(GTK_LABEL(lbl_name), PANGO_ELLIPSIZE_END);
        gtk_box_append(GTK_BOX(row), lbl_name);

        // 2. Path
        GtkWidget *lbl_path = gtk_label_new(token_orig);
        gtk_widget_set_hexpand(lbl_path, TRUE);
        gtk_widget_set_halign(lbl_path, GTK_ALIGN_START);
        gtk_label_set_ellipsize(GTK_LABEL(lbl_path), PANGO_ELLIPSIZE_START);
        gtk_box_append(GTK_BOX(row), lbl_path);

        // 3. Date
        GtkWidget *lbl_date = gtk_label_new(token_date);
        gtk_widget_set_size_request(lbl_date, 140, -1);
        gtk_box_append(GTK_BOX(row), lbl_date);

        // 4. Status
        GtkWidget *lbl_status;
        if (quarantine_exists && is_latest) {
            lbl_status = gtk_label_new("Quarantined");
        } else {
            lbl_status = gtk_label_new("Action Taken");
        }
        gtk_widget_set_size_request(lbl_status, 100, -1);
        gtk_widget_set_halign(lbl_status, GTK_ALIGN_START);
        gtk_box_append(GTK_BOX(row), lbl_status);

        // 5. Actions
        GtkWidget *actions_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5);
        GtkWidget *btn_restore = gtk_button_new_from_icon_name("system-reboot-symbolic");
        GtkWidget *btn_remove = gtk_button_new_from_icon_name("user-trash-symbolic");

        if (!quarantine_exists || !is_latest) {
            gtk_widget_set_sensitive(btn_restore, FALSE);
            gtk_widget_set_sensitive(btn_remove, FALSE);
        }

        HistoryActionData *data = g_new0(HistoryActionData, 1);
        data->orig_path   = g_strdup(token_orig);
        data->q_path      = g_strdup(token_qpath);
        data->lbl_status  = lbl_status;
        data->btn_restore = btn_restore;
        data->btn_remove  = btn_remove;
        data->app         = app;

        g_signal_connect_data(btn_restore, "clicked", G_CALLBACK(on_restore_clicked), data, NULL, 0);
        g_signal_connect_data(btn_remove, "clicked", G_CALLBACK(on_remove_clicked), data, NULL, 0);
        
        g_object_set_data_full(G_OBJECT(row), "action_data", data, free_history_action_data);

        gtk_box_append(GTK_BOX(actions_box), btn_restore);
        gtk_box_append(GTK_BOX(actions_box), btn_remove);
        gtk_box_append(GTK_BOX(row), actions_box);

        gtk_list_box_append(GTK_LIST_BOX(app->history_list_box), row);
    }

    fclose(f);
    g_hash_table_destroy(latest_entry);
}

GtkWidget *create_history_view(AppState *app) {
    GtkWidget *view = gtk_box_new(GTK_ORIENTATION_VERTICAL, 10);
    gtk_widget_set_margin_top(view, 30);
    gtk_widget_set_margin_start(view, 30);
    gtk_widget_set_margin_end(view, 30);

    GtkWidget *title = gtk_label_new(NULL);
    gtk_label_set_markup(GTK_LABEL(title), "<span font='28px' weight='bold'>Detection History</span>");
    gtk_widget_set_halign(title, GTK_ALIGN_START);
    gtk_box_append(GTK_BOX(view), title);

    // --- FIXED: ADDED MISSING HEADERS ---
    GtkWidget *header_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 15);
    gtk_widget_set_margin_start(header_box, 10);
    gtk_widget_set_margin_end(header_box, 20);

    // 1. File Name
    GtkWidget *l1 = gtk_label_new("File Name"); 
    gtk_widget_add_css_class(l1, "bold-text");
    gtk_widget_set_halign(l1, GTK_ALIGN_START);
    gtk_widget_set_size_request(l1, 120, -1); 
    gtk_box_append(GTK_BOX(header_box), l1);

    // 2. Original Path
    GtkWidget *l2 = gtk_label_new("Original Path"); 
    gtk_widget_add_css_class(l2, "bold-text");
    gtk_widget_set_halign(l2, GTK_ALIGN_START);
    gtk_widget_set_hexpand(l2, TRUE); 
    gtk_box_append(GTK_BOX(header_box), l2);

    // 3. Date/Time
    GtkWidget *l3 = gtk_label_new("Date/Time"); 
    gtk_widget_add_css_class(l3, "bold-text");
    gtk_widget_set_halign(l3, GTK_ALIGN_START);
    gtk_widget_set_size_request(l3, 140, -1); 
    gtk_box_append(GTK_BOX(header_box), l3);

    // 4. Status (MISSING BEFORE)
    GtkWidget *l4 = gtk_label_new("Status"); 
    gtk_widget_add_css_class(l4, "bold-text");
    gtk_widget_set_halign(l4, GTK_ALIGN_START);
    gtk_widget_set_size_request(l4, 100, -1); 
    gtk_box_append(GTK_BOX(header_box), l4);

    // 5. Action (MISSING BEFORE)
    GtkWidget *l5 = gtk_label_new("Action"); 
    gtk_widget_add_css_class(l5, "bold-text");
    gtk_widget_set_halign(l5, GTK_ALIGN_START);
    gtk_box_append(GTK_BOX(header_box), l5);

    gtk_box_append(GTK_BOX(view), header_box);
    gtk_box_append(GTK_BOX(view), gtk_separator_new(GTK_ORIENTATION_HORIZONTAL));
    
    app->history_list_box = gtk_list_box_new();
    gtk_widget_add_css_class(app->history_list_box, "dashboard-card-bg");
    gtk_list_box_set_selection_mode(GTK_LIST_BOX(app->history_list_box), GTK_SELECTION_NONE);

    GtkWidget *scroll = gtk_scrolled_window_new();
    gtk_scrolled_window_set_child(GTK_SCROLLED_WINDOW(scroll), app->history_list_box);
    gtk_widget_set_vexpand(scroll, TRUE);
    gtk_box_append(GTK_BOX(view), scroll);

    load_history_items(app);
    return view;
}

void reload_history_view(AppState *app) {
    load_history_items(app);
}
