#include "app.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// UI Headers
#include "ui_views.h"
#include "ui_scan.h"
#include "ui_history.h"
#include "ui_sidebar.h"
#include "ui_update.h"

// --- Global Variables ---
gboolean auto_update_enabled = TRUE;
char last_update_time[64] = "Never";

// --- STRICT CSS FROM YOUR MAIN.C ---
const char *CSS_LIGHT =
    "window { background-color: #FFFFFF; color: #1A202C; }"
    ".sidebar { background-color: #F7FAFC; border-right: 1px solid #E2E8F0; transition: min-width 200ms ease; }"
    ".dashboard-card-bg { background-color: #FFFFFF; border: 1px solid #E2E8F0; border-radius: 12px; }"
    ".protection-card-bg { background-color: #F7FAFC; border-radius: 12px; }"
    ".nav-item { background: transparent; border: none; border-radius: 6px; padding: 10px 12px; color: #4A5568; }"
    ".nav-item:hover { background: #EDF2F7; color: #2D3748; }"
    ".burger-btn { background: transparent; border: none; color: #4A5568; border-radius: 4px; padding: 8px; }"
    ".burger-btn:hover { background: #E2E8F0; color: #1A202C; }"
    ".scan-btn { background: #3182CE; color: white; border-radius: 8px; padding: 6px 16px; border: none; }"
    ".scan-btn:hover { background: #2B6CB0; }"
    ".flat-button { background: transparent; border: none; color: #4A5568; border-radius: 4px; padding: 4px; }"
    ".flat-button:hover { background: #EDF2F7; color: #1A202C; }"
    ".bold-text { font-weight: bold; font-size: 16px; }"
    ".scanner-icon { background: #EBF8FF; color: #3182CE; border-radius: 10px; padding: 8px; }"
    ".history-icon { background: #EDF2F7; color: #718096; border-radius: 50%; padding: 5px; }"
    "label { color: inherit; }"
    ".dim-label { color: #A0AEC0; font-size: 12px; }"
    ".last-update-label { color: #2D3748; font-size: 12px; }";

const char *CSS_DARK =
    "window { background-color: #171923; color: #F7FAFC; }"
    ".sidebar { background-color: #1A202C; border-right: 1px solid #2D3748; transition: min-width 200ms ease; }"
    ".dashboard-card-bg { background-color: #2D3748; border: 1px solid #4A5568; border-radius: 12px; }"
    ".protection-card-bg { background-color: #2D3748; border-radius: 12px; }"
    ".nav-item { background: transparent; border: none; border-radius: 6px; padding: 10px 12px; color: #A0AEC0; }"
    ".nav-item:hover { background: #2D3748; color: #FFFFFF; }"
    ".burger-btn { background: transparent; border: none; color: #A0AEC0; border-radius: 4px; padding: 8px; }"
    ".burger-btn:hover { background: #4A5568; color: #FFFFFF; }"
    ".scan-btn { background: #3182CE; color: white; border-radius: 8px; padding: 6px 16px; border: none; }"
    ".scan-btn:hover { background: #2B6CB0; }"
    ".flat-button { background: transparent; border: none; color: #E2E8F0; border-radius: 4px; padding: 4px; }"
    ".flat-button:hover { background: #4A5568; color: #FFFFFF; }"
    ".bold-text { font-weight: bold; font-size: 16px; }"
    ".scanner-icon { background: #2A4365; color: #63B3ED; border-radius: 10px; padding: 8px; }"
    ".history-icon { background: #2D3748; color: #A0AEC0; border-radius: 50%; padding: 5px; }"
    "label { color: inherit; }"
    ".dim-label { color: #718096; font-size: 12px; }"
    ".last-update-label { color: #CBD5E0; font-size: 12px; }";

#define SETTINGS_FILE "settings.conf"

void load_settings(void) {
    FILE *f = fopen(SETTINGS_FILE, "r");
    if (!f) return;

    char line[128];
    while (fgets(line, sizeof(line), f)) {
        if (strncmp(line, "auto_update=", 12) == 0) {
            auto_update_enabled = atoi(line + 12);
        } else if (strncmp(line, "last_update=", 12) == 0) {
            strncpy(last_update_time, line + 12, sizeof(last_update_time) - 1);
            last_update_time[strcspn(last_update_time, "\r\n")] = 0;
        }
    }
    fclose(f);
}

void save_settings(void) {
    FILE *f = fopen(SETTINGS_FILE, "w");
    if (!f) return;
    fprintf(f, "auto_update=%d\n", auto_update_enabled ? 1 : 0);
    fprintf(f, "last_update=%s\n", last_update_time);
    fclose(f);
}

void update_theme(AppState *app) {
    if (app->is_dark_mode) 
        gtk_css_provider_load_from_string(app->css_provider, CSS_DARK);
    else 
        gtk_css_provider_load_from_string(app->css_provider, CSS_LIGHT);
}

// --- App Entry ---
void app_activate(GtkApplication *gtk_app) {
    load_settings();

    AppState *app = g_new0(AppState, 1);
    app->window = gtk_application_window_new(gtk_app);
    gtk_window_set_default_size(GTK_WINDOW(app->window), 1000, 650);
    gtk_window_set_title(GTK_WINDOW(app->window), "FOS-Antivirus");

    GtkWidget *main_box = gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0);
    gtk_window_set_child(GTK_WINDOW(app->window), main_box);

    // 1. Sidebar 
    gtk_box_append(GTK_BOX(main_box), create_sidebar(app));

    // 2. Content Area
    GtkWidget *content_area = gtk_box_new(GTK_ORIENTATION_VERTICAL, 0);
    gtk_widget_set_hexpand(content_area, TRUE);
    gtk_box_append(GTK_BOX(main_box), content_area);

    // 3. Stack
    app->stack = gtk_stack_new();
    gtk_stack_set_transition_type(GTK_STACK(app->stack), GTK_STACK_TRANSITION_TYPE_CROSSFADE);
    
    // Add Views 
    gtk_stack_add_titled(GTK_STACK(app->stack), create_dashboard_view(app), "dashboard", "Dashboard");
    gtk_stack_add_titled(GTK_STACK(app->stack), create_advanced_scan_view(app), "advanced_scan", "Advanced");
    gtk_stack_add_titled(GTK_STACK(app->stack), create_history_view(app), "history", "History");
    gtk_stack_add_titled(GTK_STACK(app->stack), create_settings_view(app), "settings", "Settings");
    gtk_stack_add_titled(GTK_STACK(app->stack), create_scanner_progress_view(app), "progress", "Progress");
    gtk_stack_add_titled(GTK_STACK(app->stack), create_scan_complete_view(app), "complete", "Complete");

    gtk_box_append(GTK_BOX(content_area), app->stack);

    // CSS Setup
    app->css_provider = gtk_css_provider_new();
    app->is_dark_mode = FALSE; 
    update_theme(app);
    
    gtk_style_context_add_provider_for_display(gdk_display_get_default(), 
        GTK_STYLE_PROVIDER(app->css_provider), GTK_STYLE_PROVIDER_PRIORITY_USER);

    // Auto Update Timer
    g_timeout_add_seconds(6 * 60 * 60, auto_update_timer, app);

    // Run silent check at startup
    if (auto_update_enabled) {
        auto_update_timer(NULL);
    }

    gtk_window_present(GTK_WINDOW(app->window));
}